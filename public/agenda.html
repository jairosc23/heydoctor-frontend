<div style="padding: 20px;">

  <h1 style="font-family: Montserrat; color:#078a92;">Agenda</h1>
  <p style="color:#555;">Calendario cl√≠nico HeyDoctor ‚Äì Versi√≥n Premium</p>

  <!-- NAVEGACI√ìN DE SEMANA -->
  <div style="
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      margin:25px 0; 
      padding:14px 20px;
      background:rgba(255,255,255,0.65);
      backdrop-filter:blur(12px);
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
  ">
    <button onclick="changeWeek(-1)"
      style="padding:10px 18px; border:none; border-radius:10px; background:#d7e6e7; cursor:pointer;">
      ‚¨Ö Semana anterior
    </button>

    <h2 id="weekTitle" style="margin:0; font-family:Montserrat; font-size:22px; color:#078a92;"></h2>

    <button onclick="changeWeek(1)"
      style="padding:10px 18px; border:none; border-radius:10px; background:#07acb5; color:#fff; cursor:pointer;">
      Semana siguiente ‚ûú
    </button>
  </div>

  <!-- GRID SEMANAL -->
  <div id="weekGrid"
       style="
        margin-top:20px;
        display:grid;
        grid-template-columns:repeat(7,1fr);
        gap:14px;
  "></div>

  <!-- BOT√ìN NUEVA CONSULTA -->
  <button onclick="openNewAppointmentModal()"
    style="
      margin-top:25px; 
      width:100%; 
      padding:16px; 
      background:#07acb5; 
      border:none; 
      border-radius:12px; 
      color:white;
      font-size:16px;
      cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,0.08);
    ">
    + Registrar nueva consulta
  </button>

</div>


<!-- MODAL -->
<div id="appointmentModal"
     style="
        display:none; position:fixed; inset:0; 
        background:rgba(0,0,0,0.35); 
        justify-content:center; align-items:center;
     ">

  <div style="
      background:white; 
      padding:25px; 
      width:380px; 
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,0.15);
  ">
    <h2 style="color:#078a92; margin-top:0;">Nueva Consulta</h2>

    <input id="ap-name" type="text" placeholder="Nombre del paciente"
      style="width:100%; padding:12px; border-radius:10px; border:1px solid #ccc; margin-bottom:10px;">

    <input id="ap-date" type="date"
      style="width:100%; padding:12px; border-radius:10px; border:1px solid #ccc; margin-bottom:10px;">

    <input id="ap-time" type="time"
      style="width:100%; padding:12px; border-radius:10px; border:1px solid #ccc; margin-bottom:20px;">

    <button onclick="saveAppointment()"
      style="width:100%; padding:12px; background:#07acb5; color:white; border:none; border-radius:10px; font-size:15px;">
      Guardar
    </button>

    <button onclick="closeNewAppointmentModal()"
      style="width:100%; margin-top:10px; padding:12px; background:#ccc; border:none; border-radius:10px;">
      Cancelar
    </button>
  </div>
</div>


<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const supabase = createClient(
    "https://ozxguifbufymprfzzvin.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96eGd1aWZidWZ5bXByZnp6dmluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNDgwMjAsImV4cCI6MjA3ODkyNDAyMH0.AEiGtqpx33u-qrsgBiJ-EEa6IsDuOUAuhdUL6lme_M4"
  );

  let currentMonday = getMonday(new Date());

  function getMonday(d) {
    d = new Date(d);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(d.setDate(diff));
  }

  function changeWeek(offset) {
    currentMonday.setDate(currentMonday.getDate() + offset * 7);
    renderWeek();
  }

  async function renderWeek() {
    const start = new Date(currentMonday);
    const end = new Date(currentMonday);
    end.setDate(end.getDate() + 6);

    document.getElementById("weekTitle").innerText =
      start.toLocaleDateString("es-CL") + " ‚Äì " + end.toLocaleDateString("es-CL");

    const grid = document.getElementById("weekGrid");
    grid.innerHTML = "";

    const { data: appointments } = await supabase
      .from("appointments")
      .select("*")
      .gte("date", start.toISOString().split("T")[0])
      .lte("date", end.toISOString().split("T")[0]);

    for (let i = 0; i < 7; i++) {
      const day = new Date(currentMonday);
      day.setDate(day.getDate() + i);
      const dayStr = day.toISOString().split("T")[0];

      const dayAppts = appointments?.filter(a => a.date === dayStr) || [];

      let html = `
        <div style="
            background:rgba(255,255,255,0.75);
            backdrop-filter:blur(12px);
            padding:14px; 
            border-radius:14px; 
            min-height:150px; 
            border:1px solid rgba(0,0,0,0.08);
            box-shadow:0 4px 10px rgba(0,0,0,0.05);
        ">
          <h3 style="margin:0; font-family:Montserrat; color:#078a92; text-transform:capitalize;">
            ${day.toLocaleDateString("es-CL", { weekday: "long" })}
          </h3>
          <p style="margin:4px 0 12px; color:#666;">${dayStr}</p>
      `;

      if (dayAppts.length === 0) {
        html += `<p style="color:#aaa; font-size:14px;">‚Äî Sin consultas ‚Äî</p>`;
      } else {
        dayAppts.forEach(ap => {
          html += `
            <div style="
                padding:10px; 
                background:#e3fafb; 
                border-radius:10px; 
                margin-bottom:8px;
                border-left:4px solid #07acb5;
            ">
              <strong style="font-size:15px;">‚è± ${ap.time}</strong><br>
              üë§ ${ap.patient_name}
            </div>
          `;
        });
      }

      html += `</div>`;
      grid.innerHTML += html;
    }
  }

  window.openNewAppointmentModal = () => {
    document.getElementById("appointmentModal").style.display = "flex";
  };

  window.closeNewAppointmentModal = () => {
    document.getElementById("appointmentModal").style.display = "none";
  };

  async function saveAppointment() {
    const patient_name = document.getElementById("ap-name").value;
    const date = document.getElementById("ap-date").value;
    const time = document.getElementById("ap-time").value;

    await supabase.from("appointments").insert({ patient_name, date, time });

    closeNewAppointmentModal();
    renderWeek();
  }

  window.onload = renderWeek;
</script>
